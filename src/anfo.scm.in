; ELK extension for Anfo
;
; Loads the Anfo library and provides a wrappers/ convenience functions.
; TODO:  decide whether output streams should return anything.
;        bind missing "calculating" streams.
;        take the returning of results out of the C code (mostly...)

(require 'srfi-89)

(load "__LIBDIR__/libanfo.la")

(define *default-compression*    99)
(define *default-handles-limit* 128)
(define *default-mem-limit*     512)
(define *default-origin*         33)
(define *default-solexa-scale*   #f)

; sets sensible verbosity, but also makes sure that libanfo was actually loaded
(set-verbosity! 'warning)

; invokes continuation on stream, extracts a result, frees the stream
; The stream is always freed, even on non-local exit.  The result is
; only extracted in the normal control flow.
(define (bracket-stream stream)
  (lambda (cont)
    (dynamic-wind
      (lambda () #f)
      (lambda () (cont stream))
      (lambda () (prim-delete-stream stream)))))

(define compress:  'compress:)
(define context:   'context:)
(define editor:    'editor:)
(define genomes:   'genomes:)
(define handles:   'handles:)
(define intercept: 'intercept:)
(define label:     'label:)
(define mem:       'mem:)
(define num:       'num:)
(define origin:    'origin:)
(define quality:   'quality:)
(define score:     'score:)
(define sequences: 'sequences:)
(define solexa:    'solexa:)

(define (write-fasta    file) (bracket-stream (prim-write-fasta    file)))
(define (write-fastq    file) (bracket-stream (prim-write-fastq    file)))
(define (write-glz      file) (bracket-stream (prim-write-glz      file)))
(define (write-sam      file) (bracket-stream (prim-write-sam      file)))
(define (write-table    file) (bracket-stream (prim-write-table    file)))
(define (write-text     file) (bracket-stream (prim-write-text     file)))
(define (write-threealn file) (bracket-stream (prim-write-threealn file)))
(define (write-wiggle   file) (bracket-stream (prim-write-wiggle   file)))

(define*
  (duct-tape (label: lbl "contig"))
  (bracket-stream (prim-duct-tape lbl)))

(define* 
  (add-alns (context: ctx 0))
  (bracket-stream (prim-add-alns ctx)))

(define*
  (read-file in 
	     (solexa: sol *default-solexa-scale*)
	     (origin: ori *default-origin*))
  (bracket-stream (prim-read-file in sol ori)))

(define (filter-chain left right file) (bracket-stream (prim-filter-chain left right file)))
(define (filter-length len) (bracket-stream (prim-filter-length len)))
(define (filter-qual qual) (bracket-stream (prim-filter-qual qual)))
(define (inside-region file) (bracket-stream (prim-inside-region file)))
(define (mask-qual qual) (bracket-stream (prim-mask-qual qual)))
(define (outside-region file) (bracket-stream (prim-outside-region file)))
(define (sanitize) (bracket-stream (prim-sanitize)))
(define (subsample rate) (bracket-stream (prim-subsample rate)))

(define*
  (filter-multi (num: num 2)) 
  (bracket-stream (prim-filter-multi num)))

(define*
  (edit-header (editor: editor #f))
  (bracket-stream (prim-edit-header editor)))

(define*
  (filter-score (slope: slope 7.5)
		(intercept: intercept 20)
		(genomes: genomes '()))
  (bracket-stream (prim-filter-score slope intercept genomes)))

(define*
  (filter-mapq mapq (genomes '()))
  (bracket-stream (prim-filter-mapq mapq genomes)))

(define*
  (require-best-hit (genomes: g '()) (sequences: s '()))
  (bracket-stream (prim-require-bht g s)))

(define*
  (require-hit (genomes: g '()) (sequences: s '()))
  (bracket-stream (prim-require-hit g s)))

(define*
  (ignore-hit (genomes: g '()) (sequences: s '()))
  (bracket-stream (prim-ignore-hit g s)))

(define*
  (only-genomes (genomes '()))
  (bracket-stream (prim-only-genomes g)))

(define*
  (sort-pos genomes 
	    (mem: m *default-mem-limit*) 
	    (handles: h *default-handles-limit*))
  (bracket-stream (prim-sort-pos m h genomes)))

(define*
  (sort-name (mem: m *default-mem-limit*) 
	     (handles: h *default-handles-limit*))
  (bracket-stream (prim-sort-name m h)))

(define*
  (rmdup (slope: slope 7.5)
	 (intercept: inter 20)
	 (quality: qual 40))
  (bracket-stream (prim-rmdup slope intercept qual)))



(define*
  (write-file out
	      (compress: comp *default-compression*))
  (bracket-stream (prim-write-native out comp)))

; Run a continuation with a stream described by 'in'.  Ensures cleanup
; and sensible extraction of a result.
(define (anfo-with-input in)
  (cond
    ((procedure? in) in)
    (else (bracket-stream (prim-read-file in *default-solexa-scale* *default-origin*)))))

(define (anfo-with-output out)
  (cond
    ((procedure? out) out)
    ((string? out) (bracket-stream (prim-write-native out *default-compression*)))
    (else (error 'anfo-with-output "object does not denote an output stream: ~s" out))))

(define (anfo-with-many-inputs args cont) (anfo-with-many anfo-with-input args cont))
(define (anfo-with-many-outputs args cont) (anfo-with-many anfo-with-output args cont))
(define (anfo-with-many-filters args cont) (anfo-with-many (lambda (x) x) args cont))

(define (anfo-with-many fun args cont)
  (cond ((null? args) (cont '()))
	(else ((fun (car args))
	       (lambda (s)
		 (anfo-with-many fun (cdr args)
		   (lambda (ss) (cont (cons s ss)))))))))

(define (tee . args)
  (anfo-with-many-outputs 
    args
    (lambda (outs)
      (bracket-stream (apply prim-tee outs)))))

(define (chain . args)
  (anfo-with-many-filters
    args
    (lambda (outs)
      (bracket-stream (apply prim-chain outs)))))

(define (merge . args)
  (anfo-with-many-inputs
    args
    (lambda (outs)
      (bracket-stream (apply prim-merge outs)))))

(define (join . args)
  (anfo-with-many-inputs
    args
    (lambda (outs)
      (bracket-stream (apply prim-join outs)))))

(define (concat . args)
  (anfo-with-many-inputs
    args
    (lambda (outs)
      (bracket-stream (apply prim-concat outs)))))

(define (anfo-run in out)
  ((anfo-with-input in)
    (lambda (in-stream)
      ((anfo-with-output out)
	(lambda (out-stream)
	  (prim-anfo-run in-stream out-stream))))))

(provide 'anfo)

