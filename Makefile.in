PACKAGE_TARNAME ?= @PACKAGE_TARNAME@
prefix ?= @prefix@
exec_prefix ?= @exec_prefix@
datadir ?= @datadir@
datarootdir ?= @datarootdir@
docdir ?= @docdir@

CXX ?= @CXX@
CPP ?= @CPP@
PROTOC ?= @PROTOC@
DOXYGEN ?= @DOXYGEN@
INSTALL ?= @INSTALL@
INSTALL_PROGRAM ?= @INSTALL_PROGRAM@
INSTALL_SCRIPT ?= @INSTALL_SCRIPT@
INSTALL_DATA ?= @INSTALL_DATA@

LDLIBS ?= @LIBS@
LDFLAGS ?= @LDFLAGS@
CXXFLAGS ?= @CXXFLAGS@
DEFS ?= @DEFS@

# CXXFLAGS += -ggdb 
CXXFLAGS += -MMD -DNDEBUG
CXXFLAGS += -Wunsafe-loop-optimizations -Wall -Werror

PROGS := fa2dna dnaindex anfo-sge anfo-sort 

ifneq (,$(findstring -lpthread,$(LDLIBS)))
PROGS += anfo-standalone
endif

ifneq (,$(findstring -lenet,$(LDLIBS)))
PROGS += anfo-enet anfo-control 
endif

TARGETS := $(PROGS) index-test file-info dump-params

ifeq (@SIZEOF_INT_P@,4)
DATABASES := ../data/chr21.dna ../data/chr21_10.idx 
else
DATABASES := ../data/chr21.dna ../data/chr21_10.idx ../data/hg18.dna ../data/hg18_10.idx
endif

all: tags $(TARGETS)
dbs: $(DATABASES)

OBJECTS := align.o anfo_common.o config.pb.o index.o output.pb.o sequence.o stream.o util.o 

install: $(PROGS) $(if $(DOXYGEN),install_doc)
	test -d @bindir@ || $(INSTALL) -d -m 755 @bindir@
	$(INSTALL_PROGRAM) $(PROGS) @bindir@
	test -d @docdir@ || $(INSTALL) -d -m 755 @docdir@
	$(INSTALL_DATA) README @docdir@

install_doc: doc/html/index.html
	test -d @htmldir@/html || $(INSTALL) -d -m 755 @htmldir@/html
	$(INSTALL_DATA) doc/html/* @htmldir@/html


anfo-combine.o: output.pb.h config.pb.h
anfo-common.o: output.pb.h config.pb.h
anfo-enet.o: output.pb.h config.pb.h
anfo-standalone.o: config.pb.h output.pb.h
anfo2fna.o: output.pb.h config.pb.h
dnaindex.cc: config.pb.h
dump-params.o: output.pb.h config.pb.h
fa2dna.o: config.pb.h
file-info.o: config.pb.h output.pb.h
index-test.o: output.pb.h config.pb.h

../data/hg18.dna: fa2dna
	./fa2dna -g hg18 -d "Homo Sapiens genome, revision 18" -O ${@D} -v \
	    	/mnt/sequencedb/ucsc/goldenPath/hg18/bigZips/chr*.fa

../data/chr21.dna: fa2dna
	./fa2dna -g chr21 -d "Homo Sapiens chromosome 21" -O ${@D} -v \
		/mnt/sequencedb/ucsc/goldenPath/hg18/bigZips/chr21.fa

../data/hg18_10.idx: ../data/hg18.dna dnaindex
	./dnaindex -O ${@D} -G ${<D} -g ${<F} -v -s 10

../data/chr21_10.idx: ../data/chr21.dna dnaindex
	./dnaindex -O ${@D} -G ${<D} -g ${<F} -v -s 10

%: %.o $(OBJECTS)
	$(CXX) $(DEFS) $(LDFLAGS) $^ -o $@ $(LDLIBS) 
 
%.o: %.cc
	$(CXX) $(DEFS) $(CXXFLAGS) -c $< -o $@

%.pb.cc %.pb.h: %.proto
	$(PROTOC) --cpp_out=$(*D) $<

-include *.d

.PRECIOUS: %.o %.pb.cc %.pb.h
.PHONY: clean all doc
.SUFFIXES:

doc: doc/html/index.html

doc/html/index.html: Doxyfile *.cc *.h
	$(DOXYGEN)

tags: *.cc *.h
	-ctags -R --exclude=*.pb.cc --exclude=*.pb.h 

clean:
	-rm $(TARGETS)
	-rm -r doc
	-rm *.o *.d *.pb.cc *.pb.h

