PACKAGE_TARNAME ?= @PACKAGE_TARNAME@
prefix ?= @prefix@
exec_prefix ?= @exec_prefix@
datadir ?= @datadir@
datarootdir ?= @datarootdir@
docdir ?= @docdir@
htmldir ?= @htmldir@
mandir ?= @mandir@

CXX ?= @CXX@
CPP ?= @CPP@
PROTOC ?= @PROTOC@
DOXYGEN ?= @DOXYGEN@
INSTALL ?= @INSTALL@
INSTALL_PROGRAM ?= @INSTALL_PROGRAM@
INSTALL_SCRIPT ?= @INSTALL_SCRIPT@
INSTALL_DATA ?= @INSTALL_DATA@

LDLIBS ?= @LIBS@
LDFLAGS ?= @LDFLAGS@
CXXFLAGS ?= @CXXFLAGS@
DEFS ?= @DEFS@

CXXFLAGS += -MMD -Wall -Werror

CXXFLAGS += -DNDEBUG -O3 -fomit-frame-pointer -march=k8
# CXXFLAGS += -ggdb -O0

PROGS := fa2dna dnaindex anfo-sge anfo-tool 

ifneq (,$(findstring -lpthread,$(LDLIBS)))
PROGS += anfo-standalone
endif

TARGETS := $(PROGS) index-test file-info dump-params

all: tags $(TARGETS)

OBJECTS := align.o anfo_common.o config.pb.o ducttape.o index.o output.pb.o output_streams.o sequence.o stream.o util.o 

install: $(PROGS)
	test -d $(bindir) || $(INSTALL) -d -m 755 $(bindir)
	$(INSTALL_PROGRAM) $(PROGS) $(bindir)
	test -d $(docdir) || $(INSTALL) -d -m 755 $(docdir)
	$(INSTALL_DATA) README $(docdir)
	test -d $(mandir) || $(INSTALL) -d -m 755 $(mandir)/man1
	$(INSTALL_DATA) fa2dna.1 $(mandir)/man1

install_doc: doc/html/index.html
	test -d $(htmldir)/html || $(INSTALL) -d -m 755 $(htmldir)/html
	$(INSTALL_DATA) doc/html/* $(htmldir)/html


anfo-shell: anfo-shell.cc $(OBJECTS)
	$(CXX) $(DEFS) $(LDFLAGS) $(CXXFLAGS) @GUILE_CFLAGS@ $^ -o $@ @GUILE_LDFLAGS@ $(LDLIBS) 

%: %.o $(OBJECTS)
	$(CXX) $(DEFS) $(LDFLAGS) $^ -o $@ $(LDLIBS) 
 
%.o: %.cc config.pb.h output.pb.h
	$(CXX) $(DEFS) $(CXXFLAGS) -c $< -o $@

%.pb.cc %.pb.h: %.proto
	$(PROTOC) --cpp_out=$(*D) $<

-include *.d

.PRECIOUS: %.o %.pb.cc %.pb.h
.PHONY: clean all doc
.SUFFIXES:

doc: doc/html/index.html

doc/html/index.html: Doxyfile *.cc *.h
	$(DOXYGEN)

tags: *.cc *.h
	-ctags -R --exclude=*.pb.cc --exclude=*.pb.h 

dist-clean:
	-rm *.o *.d *.pb.cc *.pb.h

clean:
	-rm -r doc
	-rm $(TARGETS) anfo-shell
