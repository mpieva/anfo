PACKAGE_TARNAME ?= @PACKAGE_TARNAME@
prefix ?= @prefix@
exec_prefix ?= @exec_prefix@
datadir ?= @datadir@
datarootdir ?= @datarootdir@
bindir ?= @bindir@
docdir ?= @docdir@
htmldir ?= @htmldir@
mandir ?= @mandir@

CXX ?= @CXX@
CPP ?= @CPP@
PROTOC ?= @PROTOC@
DOXYGEN ?= @DOXYGEN@
INSTALL ?= @INSTALL@
INSTALL_PROGRAM ?= @INSTALL_PROGRAM@
INSTALL_SCRIPT ?= @INSTALL_SCRIPT@
INSTALL_DATA ?= @INSTALL_DATA@

LDLIBS ?= @LIBS@
LDFLAGS ?= @LDFLAGS@
CXXFLAGS ?= @CXXFLAGS@
DEFS ?= @DEFS@

CXXFLAGS += -MMD -Wall -Werror

CXXFLAGS += -DNDEBUG -O3 -fomit-frame-pointer -march=k8
# CXXFLAGS += -ggdb -O0

PROGS := src/fa2dna   src/dnaindex   src/anfo-sge   src/anfo-tool   src/file-info 
MANS  := man/fa2dna.1 man/dnaindex.1 man/anfo-sge.1 man/anfo-tool.1 man/file-info.1

ifneq (,$(findstring -lpthread,$(LDLIBS)))
    PROGS += src/anfo
    MANS  += man/anfo.1
endif

ifneq (,@GUILE@)
    PROGS += src/anfo-shell
    MANS  += man/anfo-shell.1
endif

TARGETS := $(PROGS) src/index-test 

all: tags $(TARGETS)

OBJECTS := src/align.o src/anfo_common.o src/config.pb.o src/ducttape.o \
	   src/index.o src/output.pb.o src/output_streams.o \
	   src/sequence.o src/stream.o src/util.o 

install: $(TARGETS) $(if $(DOXYGEN), install_doc)
	test -d $(bindir) || $(INSTALL) -d -m 755 $(bindir)
	$(INSTALL_PROGRAM) $(PROGS) $(bindir)
	test -d $(docdir) || $(INSTALL) -d -m 755 $(docdir)
	$(INSTALL_DATA) README $(docdir)
	test -d $(mandir) || $(INSTALL) -d -m 755 $(mandir)/man1
	$(INSTALL_DATA) $(MANS) $(mandir)/man1

install_doc: doc/html/index.html
	test -d $(htmldir)/html || $(INSTALL) -d -m 755 $(htmldir)/html
	$(INSTALL_DATA) doc/html/* $(htmldir)/html


src/anfo-shell: src/anfo-shell.cc $(OBJECTS)
	$(CXX) $(DEFS) $(LDFLAGS) $(CXXFLAGS) @GUILE_CFLAGS@ $^ -o $@ @GUILE_LDFLAGS@ $(LDLIBS) 

%: %.o $(OBJECTS)
	$(CXX) $(DEFS) $(LDFLAGS) $^ -o $@ $(LDLIBS) 
 
%.o: %.cc src/config.pb.h src/output.pb.h
	$(CXX) $(DEFS) $(CXXFLAGS) -c $< -o $@

%.pb.cc %.pb.h: %.proto
	$(PROTOC) -I src --cpp_out=$(*D) $<

-include src/*.d

.PRECIOUS: %.o %.pb.cc %.pb.h
.PHONY: clean mostly-clean dist-clean all doc
.SUFFIXES:

doc: doc/html/index.html

doc/html/index.html: Doxyfile src/*.cc src/*.h
	$(DOXYGEN)

tags: src/*.cc src/*.h
	-ctags -R --exclude=*.pb.cc --exclude=*.pb.h 

mostly-clean:
	-rm src/*.o src/*.d src/*.pb.cc src/*.pb.h

dist-clean: mostly-clean
	-rm -r Makefile autom4te.cache config.h config.log config.status tags 

clean: mostly-clean
	-rm -r doc
	-rm $(TARGETS)
